// prisma/schema.prisma

generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  USER
  PROFESSIONAL
  ADMIN
  SUPERADMIN
}

enum UserStatus {
  Active
  Inactive
  Suspended
}

enum BookingStatus {
  Pending
  Confirmed
  Completed
  Cancelled
  Rescheduled
}

enum BookingModality {
  Video
  Audio
}

enum NotificationType {
  BookingRequest
  BookingConfirmed
  BookingCancelled
  BookingRescheduled
  BookingCompleted
  NewMessage
}

enum DiagnosisStatus {
  Yes
  No
  Unsure
}

enum EchoRoom {
  pressure
  burnout
  not_enough
  silence
  rage
  exhaustion
  gratitude
  victory
  hope
  resilience
}

enum EchoSentiment {
  struggle
  positive
  neutral
}

// ============================================
// COMPLIANCE TABLES (HIPAA/Healthcare)
// ============================================

model AuditLog {
  id            String   @id @default(cuid())
  userId        String?
  action        String
  resourceType  String?
  resourceId    String?
  ipAddress     String?
  userAgent     String?
  metadata      Json?
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model ConsentRecord {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  consentType String
  version     String
  givenAt     DateTime
  expiresAt   DateTime?
  revokedAt   DateTime?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@map("consent_records")
}

// ============================================
// USER & AUTH MODELS
// ============================================

model User {
  id             String   @id @default(cuid())
  pseudonymousId String   @unique @default(cuid())
  userId         String   @unique @default(cuid())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Compliance Fields
  consentGivenAt       DateTime
  consentVersion       String   @default("2.0")
  privacyPolicyVersion String   @default("2.0")

  // Basic Info
  name     String
  username String  @unique
  email    String  @unique
  password String
  avatar   String?
  mobile   String?

  // Authentication
  verifyEmail          Boolean   @default(false)
  refreshToken         String?
  lastLoginDate        DateTime?
  forgotPasswordOtp    String?
  forgotPasswordExpiry DateTime?

  // Status & Role
  status UserStatus @default(Active)
  role   UserRole   @default(USER)

  // Professional Fields
  isPeerCounselor   Boolean  @default(false)
  counselorId       String?  @unique
  specialization    String?
  qualifications    String[]
  bio               String?
  yearsOfExperience Int?

  // Relations
  survey                Survey?
  bookingsAsUser        Booking[]            @relation("UserBookings")
  bookingsAsPro         Booking[]            @relation("ProfessionalBookings")
  availability          Availability[]
  blogPosts             BlogPost[]
  blogComments          BlogComment[]
  notificationsSent     Notification[]       @relation("NotificationSender")
  notificationsReceived Notification[]       @relation("NotificationRecipient")
  preAuthorizations     PreAuthorization[]
  consentRecords        ConsentRecord[]
  emergencyContacts     EmergencyContact[]

  @@index([email])
  @@index([role])
  @@index([status])
  @@index([pseudonymousId])
  @@map("users")
}

model OTP {
  id        String   @id @default(cuid())
  email     String   @unique
  otp       String
  expiry    DateTime
  attempts  Int      @default(0)
  userData  Json
  createdAt DateTime @default(now())

  @@index([email])
  @@map("otps")
}

model PreAuthorization {
  id           String   @id @default(cuid())
  email        String   @unique
  authorizedBy String
  authorizer   User     @relation(fields: [authorizedBy], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([authorizedBy])
  @@map("pre_authorizations")
}

// ============================================
// BOOKING SYSTEM
// ============================================

model Availability {
  id               String   @id @default(cuid())
  professional     String
  professionalUser User     @relation(fields: [professional], references: [id], onDelete: Cascade)
  day              String
  slots            Json
  available        Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([professional, day])
  @@index([professional])
  @@map("availabilities")
}

model Booking {
  id                      String          @id @default(cuid())
  userPseudonymousId      String
  counselorPseudonymousId String
  user                    User            @relation("UserBookings", fields: [userPseudonymousId], references: [pseudonymousId], onDelete: Cascade)
  professional            User            @relation("ProfessionalBookings", fields: [counselorPseudonymousId], references: [pseudonymousId], onDelete: Cascade)
  date                    DateTime
  startTime               String
  endTime                 String
  modality                BookingModality
  concern                 String
  notes                   String?
  meetingLink             String?
  meetingPassword         String?
  status                  BookingStatus   @default(Pending)
  cancellationReason      String?
  rescheduledFrom         String?
  reminderSent            Boolean         @default(false)
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt
  notifications           Notification[]

  @@index([userPseudonymousId])
  @@index([counselorPseudonymousId])
  @@index([date])
  @@index([status])
  @@map("bookings")
}

// ============================================
// CHAT SYSTEM (ENCRYPTED)
// ============================================

model ChatSession {
  id                      String        @id @default(cuid())
  patientPseudonymousId   String
  counselorPseudonymousId String
  sessionType             String        @default("peer")
  encryptionKeyId         String
  crisisDetected          Boolean       @default(false)
  crisisLevel             String?
  crisisIntervention      Json?
  status                  String        @default("active")
  startedAt               DateTime      @default(now())
  endedAt                 DateTime?
  createdAt               DateTime      @default(now())
  updatedAt               DateTime      @updatedAt
  messages                ChatMessage[]

  @@index([patientPseudonymousId])
  @@index([counselorPseudonymousId])
  @@index([crisisDetected])
  @@map("chat_sessions")
}

model ChatMessage {
  id                   String      @id @default(cuid())
  sessionId            String
  session              ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  senderType           String
  senderPseudonymousId String
  encryptedContent     String
  encryptionKeyId      String
  sentimentAnalysis    Json?
  riskScore            Decimal?    @db.Decimal(3, 2)
  flaggedKeywords      String[]
  createdAt            DateTime    @default(now())
  indexedAt            DateTime    @default(now())

  @@index([sessionId])
  @@index([senderPseudonymousId])
  @@index([createdAt])
  @@map("chat_messages")
}

// ============================================
// SURVEY SYSTEM
// ============================================

model Survey {
  id               String          @id @default(cuid())
  user             String          @unique
  userRel          User            @relation(fields: [user], references: [id], onDelete: Cascade)
  ageRange         String
  gender           String
  concerns         String[]
  otherConcern     String?
  diagnosed        DiagnosisStatus
  diagnosisDetails String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@map("surveys")
}

// ============================================
// BLOG SYSTEM
// ============================================

model BlogPost {
  id            String         @id @default(cuid())
  title         String
  slug          String         @unique
  content       String
  excerpt       String?
  featuredImage String?
  author        String
  authorRel     User           @relation(fields: [author], references: [id], onDelete: Cascade)
  categories    BlogCategory[]
  tags          String[]
  readTime      Int            @default(5)
  published     Boolean        @default(true)
  views         Int            @default(0)
  comments      BlogComment[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([author])
  @@index([slug])
  @@map("blog_posts")
}

model BlogCategory {
  id          String     @id @default(cuid())
  name        String     @unique
  slug        String     @unique
  description String?
  posts       BlogPost[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@map("blog_categories")
}

model BlogComment {
  id        String   @id @default(cuid())
  content   String
  author    String
  authorRel User     @relation(fields: [author], references: [id], onDelete: Cascade)
  post      String
  postRel   BlogPost @relation(fields: [post], references: [id], onDelete: Cascade)
  approved  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([post])
  @@index([author])
  @@map("blog_comments")
}

// ============================================
// ECHO (ANONYMOUS STORIES)
// ============================================

model Echo {
  id           String        @id @default(cuid())
  content      String
  authorName   String
  room         EchoRoom
  sentiment    EchoSentiment @default(neutral)
  wordCount    Int           @default(0)
  moderated    Boolean       @default(true)
  crisisFlag   Boolean       @default(false)
  isArchived   Boolean       @default(false)
  reportCount  Int           @default(0)
  emotionTags  String[]
  likes        Json          @default("[]")
  comments     Json          @default("[]")
  shareCount   Int           @default(0)
  shareLogs    Json          @default("[]")
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([room])
  @@index([createdAt])
  @@map("echoes")
}

model RoomStats {
  id               String   @id @default(cuid())
  roomId           String   @unique
  totalStories     Int      @default(0)
  todaysStories    Int      @default(0)
  lastUpdated      DateTime @default(now())
  trending         Boolean  @default(false)
  averageWordCount Int      @default(0)
  crisisCount      Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("room_stats")
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id            String           @id @default(cuid())
  recipient     String
  sender        String?
  recipientUser User             @relation("NotificationRecipient", fields: [recipient], references: [id], onDelete: Cascade)
  senderUser    User?            @relation("NotificationSender", fields: [sender], references: [id], onDelete: SetNull)
  booking       String?
  bookingRel    Booking?         @relation(fields: [booking], references: [id], onDelete: Cascade)
  type          NotificationType
  message       String
  isRead        Boolean          @default(false)
  createdAt     DateTime         @default(now())

  @@index([recipient])
  @@index([isRead])
  @@map("notifications")
}

// ============================================
// EMERGENCY CONTACTS
// ============================================

model EmergencyContact {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name           String
  relationship   String?
  phone          String
  email          String?
  canBeContacted Boolean  @default(true)
  consentGivenAt DateTime
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([userId])
  @@map("emergency_contacts")
}

// ============================================
// PSN (PEER SUPPORT NETWORK)
// ============================================

model PSNApplication {
  id              String    @id @default(cuid())
  userId          String
  motivation      String
  availability    String
  experience      String
  status          String    @default("Pending")
  applicationDate DateTime  @default(now())
  reviewedAt      DateTime?
  reviewedBy      String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([status])
  @@map("psn_applications")
}

model PSNModule {
  id          String   @id @default(cuid())
  title       String
  description String?
  videoUrl    String?
  content     String
  order       Int
  weekNumber  Int
  unlockDate  DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([order])
  @@map("psn_modules")
}

model PSNProgress {
  id             String    @id @default(cuid())
  userId         String
  moduleId       String
  completed      Boolean   @default(false)
  preAssessment  Json?
  postAssessment Json?
  videoWatched   Boolean   @default(false)
  completedAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@unique([userId, moduleId])
  @@index([userId])
  @@map("psn_progress")
}